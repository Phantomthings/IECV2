import asyncio
from fastapi import APIRouter, HTTPException, BackgroundTasks
from fastapi.responses import HTMLResponse
from starlette.requests import Request
from fastapi.templating import Jinja2Templates
from config import VARIABLES

router = APIRouter()
templates = Jinja2Templates(directory="templates")

def get_status_color(color_code):
    color_map = {
        0: "gray",
        1: "rgb(16, 185, 129)",
        2: "rgb(0, 255, 255)",
        3: "rgb(255, 99, 71)",
        4: "rgb(255, 215, 0)"
    }
    return color_map.get(color_code, "gray")

@router.get("/exploitation", response_class=HTMLResponse)
async def exploitation_page(request: Request):
    return templates.TemplateResponse("exploitation.html", {"request": request})

@router.get("/api/exploitation/cs1")
async def get_cs1_data():
    try:
        from main import get_opcua_client
        opcua = get_opcua_client()
        
        pdc1_status_text = await opcua.read_variable(VARIABLES["pdc1_status_text"])
        pdc1_status_color = await opcua.read_variable(VARIABLES["pdc1_status_color"])
        pdc2_status_text = await opcua.read_variable(VARIABLES["pdc2_status_text"])
        pdc2_status_color = await opcua.read_variable(VARIABLES["pdc2_status_color"])
        
        pdc1_manu_indispo = await opcua.read_variable(VARIABLES["pdc1_manu_indispo"])
        pdc2_manu_indispo = await opcua.read_variable(VARIABLES["pdc2_manu_indispo"])

        pdc12_tilt_sensor = await opcua.read_variable(VARIABLES["tilt_sensor_pdc12"])
        pdc12_ack_tilt = await opcua.read_variable(VARIABLES["pdc12_ack_tilt"])
        pdc12_restart = await opcua.read_variable(VARIABLES["pdc12_restart"])
        endpoint12_ok = await opcua.read_variable(VARIABLES["endpoint12_ok"])
        
        evip1_remote = await opcua.read_variable(VARIABLES["evip1_remote_unavailable"])
        evip2_remote = await opcua.read_variable(VARIABLES["evip2_remote_unavailable"])

        pdc12_paiement = await opcua.read_variable(VARIABLES["paiement_bypass_12"])

        pdc1_color = get_status_color(pdc1_status_color)
        pdc2_color = get_status_color(pdc2_status_color)
        
        pdc1_manu_class = "cmd-btn-stop-active" if pdc1_manu_indispo else "cmd-btn"
        pdc2_manu_class = "cmd-btn-stop-active" if pdc2_manu_indispo else "cmd-btn"
        pdc12_tilt_sensor_class = "danger" if pdc12_tilt_sensor else "inactive"
        pdc12_ack_tilt_class = "cmd-btn-active" if pdc12_ack_tilt else "cmd-btn"
        pdc12_restart_class = "cmd-btn-stop-active" if pdc12_restart else "cmd-btn"
        
        endpoint12_class = "success" if endpoint12_ok else "danger"
        evip1_class = "danger" if evip1_remote else "inactive"
        evip2_class = "danger" if evip2_remote else "inactive"

        paiement_12_class = "cmd-btn-stop-active" if pdc12_paiement else "cmd-btn"

        html = f"""
        <div class="seq-section">
            <div class="data-row">
                <span class="label">PDC1 Status</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="value" style="color: {pdc1_color}">{pdc1_status_text}</span>
                    <span class="indicator" style="background: {pdc1_color};"></span>
                </div>
            </div>
            <div class="data-row">
                <span class="label">PDC2 Status</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="value" style="color: {pdc2_color}">{pdc2_status_text}</span>
                    <span class="indicator" style="background: {pdc2_color};"></span>
                </div>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>PDC Unavailable Manually</h4>
            <div class="cmd-row">
                <button class="{pdc1_manu_class}" hx-post="/api/exploitation/pdc1_manu_indispo/toggle" hx-swap="none">Manu Indispo PDC1</button>
                <button class="{pdc2_manu_class}" hx-post="/api/exploitation/pdc2_manu_indispo/toggle" hx-swap="none">Manu Indispo PDC2</button>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>CS1 Tilt Sensor</h4>
            <div class="data-row">
                <span class="label">Tilt Sensor PDC12</span>
                <span class="indicator {pdc12_tilt_sensor_class}"></span>
            </div>
            <div class="cmd-row">
                <button class="{pdc12_ack_tilt_class}" hx-post="/api/exploitation/pdc12_ack_tilt/toggle" hx-swap="none">ACK Tilt PDC12</button>
            </div>
        </div>
        <div class="seq-section">
            <h4>CS1 Control and Rebooting</h4>
            <div class="cmd-row">
                <button class="{pdc12_restart_class}" hx-post="/api/exploitation/pdc12_restart/toggle" hx-swap="none">Restart PDC12</button>
                <button class="{paiement_12_class}" hx-post="/api/exploitation/paiement_12/toggle" hx-swap="none">Bypass payment</button>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>Connexion EndPoint12 via ZMQ</h4>
            <div class="data-row">
                <span class="label">EndPoint12 Connected</span>
                <span class="indicator {endpoint12_class}"></span>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>Change Availability from CPO ENDPOINT12</h4>
            <div class="data-row">
                <span class="label">PDC1</span>
                <span class="indicator {evip1_class}"></span>
            </div>
            <div class="data-row">
                <span class="label">PDC2</span>
                <span class="indicator {evip2_class}"></span>
            </div>
        </div>
        """
        
        return HTMLResponse(html)
    except Exception as e:
        return HTMLResponse(f'<div class="seq-section"><span class="label">Error: {str(e)}</span></div>')

@router.get("/api/exploitation/cs2")
async def get_cs2_data():
    try:
        from main import get_opcua_client
        opcua = get_opcua_client()
        
        pdc3_status_text = await opcua.read_variable(VARIABLES["pdc3_status_text"])
        pdc3_status_color = await opcua.read_variable(VARIABLES["pdc3_status_color"])
        pdc4_status_text = await opcua.read_variable(VARIABLES["pdc4_status_text"])
        pdc4_status_color = await opcua.read_variable(VARIABLES["pdc4_status_color"])
        
        pdc3_manu_indispo = await opcua.read_variable(VARIABLES["pdc3_manu_indispo"])
        pdc4_manu_indispo = await opcua.read_variable(VARIABLES["pdc4_manu_indispo"])

        pdc34_tilt_sensor = await opcua.read_variable(VARIABLES["tilt_sensor_pdc34"])
        pdc34_ack_tilt = await opcua.read_variable(VARIABLES["pdc34_ack_tilt"])
        pdc34_restart = await opcua.read_variable(VARIABLES["pdc34_restart"])
        endpoint34_ok = await opcua.read_variable(VARIABLES["endpoint34_ok"])
        
        evip3_remote = await opcua.read_variable(VARIABLES["evip3_remote_unavailable"])
        evip4_remote = await opcua.read_variable(VARIABLES["evip4_remote_unavailable"])
        pdc34_paiement = await opcua.read_variable(VARIABLES["paiement_bypass_34"])

        pdc3_color = get_status_color(pdc3_status_color)
        pdc4_color = get_status_color(pdc4_status_color)
        
        pdc3_manu_class = "cmd-btn-stop-active" if pdc3_manu_indispo else "cmd-btn"
        pdc4_manu_class = "cmd-btn-stop-active" if pdc4_manu_indispo else "cmd-btn"
        pdc34_ack_tilt_class = "cmd-btn-active" if pdc34_ack_tilt else "cmd-btn"
        pdc34_tilt_sensor_class = "danger" if pdc34_tilt_sensor else "inactive"
        pdc34_restart_class = "cmd-btn-stop-active" if pdc34_restart else "cmd-btn"
        
        endpoint34_class = "success" if endpoint34_ok else "danger"
        evip3_class = "danger" if evip3_remote else "inactive"
        evip4_class = "danger" if evip4_remote else "inactive"
        paiement_34_class = "cmd-btn-stop-active" if pdc34_paiement else "cmd-btn"
        
        html = f"""
        <div class="seq-section">
            <div class="data-row">
                <span class="label">PDC3 Status</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="value" style="color: {pdc3_color}">{pdc3_status_text}</span>
                    <span class="indicator" style="background: {pdc3_color};"></span>
                </div>
            </div>
            <div class="data-row">
                <span class="label">PDC4 Status</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="value" style="color: {pdc4_color}">{pdc4_status_text}</span>
                    <span class="indicator" style="background: {pdc4_color};"></span>
                </div>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>PDC Unavailable Manually</h4>
            <div class="cmd-row">
                <button class="{pdc3_manu_class}" hx-post="/api/exploitation/pdc3_manu_indispo/toggle" hx-swap="none">Manu Indispo PDC3</button>
                <button class="{pdc4_manu_class}" hx-post="/api/exploitation/pdc4_manu_indispo/toggle" hx-swap="none">Manu Indispo PDC4</button>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>CS2 Tilt Sensor</h4>
            <div class="data-row">
                <span class="label">Tilt Sensor PDC34</span>
                <span class="indicator {pdc34_tilt_sensor_class}"></span>
            </div>
            <div class="cmd-row">
                <button class="{pdc34_ack_tilt_class}" hx-post="/api/exploitation/pdc34_ack_tilt/toggle" hx-swap="none">ACK Tilt PDC34</button>
            </div>
        </div>
        <div class="seq-section">
            <h4>CS2 Control and Rebooting</h4>
            <div class="cmd-row">
                <button class="{pdc34_restart_class}" hx-post="/api/exploitation/pdc34_restart/toggle" hx-swap="none">Restart PDC34</button>
                <button class="{paiement_34_class}" hx-post="/api/exploitation/paiement_34/toggle" hx-swap="none">Bypass payment</button>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>Connexion EndPoint34 via ZMQ</h4>
            <div class="data-row">
                <span class="label">EndPoint34 Connected</span>
                <span class="indicator {endpoint34_class}"></span>
            </div>
        </div>
        
        <div class="seq-section">
            <h4>Change Availability from CPO ENDPOINT34</h4>
            <div class="data-row">
                <span class="label">PDC3</span>
                <span class="indicator {evip3_class}"></span>
            </div>
            <div class="data-row">
                <span class="label">PDC4</span>
                <span class="indicator {evip4_class}"></span>
            </div>
        </div>
        """
        
        return HTMLResponse(html)
    except Exception as e:
        return HTMLResponse(f'<div class="seq-section"><span class="label">Error: {str(e)}</span></div>')

@router.post("/api/exploitation/{pdc}_ack_tilt/toggle")
async def ack_tilt_toggle(pdc: str):
    try:
        from main import get_opcua_client
        opcua = get_opcua_client()
        variable_name = VARIABLES[f"{pdc}_ack_tilt"]
        current = await opcua.read_variable(variable_name)
        await opcua.write_variable(variable_name, not current)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/api/exploitation/{pdc}_restart/toggle")
async def restart_toggle(pdc: str):
    try:
        from main import get_opcua_client
        opcua = get_opcua_client()
        variable_name = VARIABLES[f"{pdc}_restart"]
        current = await opcua.read_variable(variable_name)
        await opcua.write_variable(variable_name, not current)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/api/exploitation/{pdc}_manu_indispo/toggle")
async def manu_indispo_toggle(pdc: str):
    try:
        from main import get_opcua_client
        opcua = get_opcua_client()
        variable_name = VARIABLES[f"{pdc}_manu_indispo"]
        current = await opcua.read_variable(variable_name)
        await opcua.write_variable(variable_name, not current)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/api/exploitation/paiement_12/toggle")
async def toggle_paiement_12(background_tasks: BackgroundTasks):
    try:
        from main import get_opcua_client
        opcua = get_opcua_client()
        
        current_value = await opcua.read_variable(VARIABLES["paiement_bypass_12"])
        new_value = not current_value
        await opcua.write_variable(VARIABLES["paiement_bypass_12"], new_value)
        
        return {"status": "ok", "new_value": new_value}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/api/exploitation/paiement_34/toggle")
async def toggle_paiement_34(background_tasks: BackgroundTasks):
    try:
        from main import get_opcua_client
        opcua = get_opcua_client()
        
        current_value = await opcua.read_variable(VARIABLES["paiement_bypass_34"])
        new_value = not current_value
        await opcua.write_variable(VARIABLES["paiement_bypass_34"], new_value)
        
        return {"status": "ok", "new_value": new_value}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))