{% extends "base.html" %}

{% block title %}Communication - SCADA{% endblock %}
{% block nav_communication %}active{% endblock %}
{% block page_title %}Communication{% endblock %}

{% block content %}
<div class="card full-width">
    <div class="card-header">
        <h3>Communication</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;" 
             hx-get="/api/communication" 
             hx-trigger="load, every 2s"
             hx-swap="innerHTML">
            <div class="comm-item">
                <span class="comm-label">Chargement...</span>
            </div>
        </div>
    </div>
</div>

<div class="card full-width" style="margin-top: 1rem;">
    <div class="card-header">
        <h3>Modules Status</h3>
    </div>
    <div class="card-body" style="background: #f5f5f5; padding: 0; width: 50%; margin: 0 auto;">
        <div style="display: flex; flex-wrap: wrap; gap: 0;">
            <div style="position: relative; width: 50%;">
                <object id="svg-M14" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M14</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M12" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M12</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M13" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M13</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M11" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M11</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M10" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M10</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M8" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M8</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M9" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M9</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M7" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M7</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M6" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M6</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M4" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M4</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M5" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M5</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M3" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M3</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M2" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M2</span>
            </div>
            <div style="position: relative; width: 50%;">
                <object id="svg-M1" data="/static/svg/modules.svg" type="image/svg+xml" style="width: 100%; display: block; margin: 0; padding: 0;"></object>
                <span style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 15px; font-weight: bold; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">M1</span>
            </div>
        </div>
    </div>
</div>

<script>
let loadedCount = 0;
const totalModules = 14;

async function updateModules() {
    try {
        const data = await fetch('/api/communication/modules').then(r => r.json());
        console.log('Data received:', data);
        
        if (data.modules) {
            for (const [moduleId, status] of Object.entries(data.modules)) {
                const svgObj = document.getElementById(`svg-${moduleId}`);
                
                if (svgObj && svgObj.contentDocument) {
                    const led = svgObj.contentDocument.getElementById('led-green');
                    
                    if (led) {
                        if (status.fault) {
                            led.setAttribute('fill', 'url(#ledGlowGreen)');
                        } else {
                            led.setAttribute('fill', 'url(#ledGlowRed)');
                        }
                    }
                }
            }
        }
    } catch (e) {
        console.error('Error:', e);
    }
}

for (let i = 1; i <= totalModules; i++) {
    const svgObj = document.getElementById(`svg-M${i}`);
    if (svgObj) {
        svgObj.addEventListener('load', () => {
            loadedCount++;
            if (loadedCount === totalModules) {
                console.log('All SVGs loaded!');
                updateModules();
                setInterval(updateModules, 2000);
            }
        });
    }
}
</script>
{% endblock %}